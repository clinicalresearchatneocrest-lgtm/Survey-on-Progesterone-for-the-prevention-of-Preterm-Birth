<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Preterm Birth – SurveyJS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SurveyJS (vanilla) -->
  <link href="https://unpkg.com/survey-core/survey-core.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/survey-core/survey.core.min.js"></script>
  <script src="https://unpkg.com/survey-js-ui/survey-js-ui.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">

  <style>
    body { margin: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #pageWrap { max-width: 960px; margin: 0 auto; }

    #errbox{
      background:#fff3cd; color:#664d03; border:1px solid #ffecb5;
      padding:12px; border-radius:8px; margin:12px 0; display:none;
      white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .custom-header { margin-bottom: 16px; }
    .custom-title{
      font-family: "Questrial", Arial, sans-serif;
      font-size:14px; font-weight:600; line-height:1.35; letter-spacing:0.2px;
      margin:0 0 6px 0;
    }
    .custom-description{
      font-family: "Questrial", Arial, sans-serif;
      font-size:12px; font-weight:400; line-height:1.5; color:#333;
      white-space:pre-wrap;
      margin:0;
    }

    .sd-root-modern, .sv-root {
      --sjs-font-family: "Questrial", Arial, sans-serif;
      font-family: var(--sjs-font-family);
    }
    #surveyContainer .sd-header,
    #surveyContainer .sv-header { display:none !important; }

    /* OTP UI */
    .otpBox {
      border: 1px solid #ccc;
      padding: 14px;
      border-radius: 8px;
      margin: 10px 0 18px 0;
      background: #fff;
    }
    .otpTitle { font-weight: 700; margin-bottom: 6px; }
    .otpHint { margin: 6px 0 0 0; font-size: 12px; color: #444; }
    .otpRow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
    .otpRow input { padding:10px; border:1px solid #ccc; border-radius:8px; min-width:240px; }
    .otpRow button { padding:10px 14px; border:1px solid #333; background:#fff; border-radius:8px; cursor:pointer; }
    .otpOk { color:#0a7a0a; font-weight:700; }
    .otpBad { color:#b00020; font-weight:700; }
  </style>
</head>

<body>
<div id="pageWrap">
  <noscript>Enable JavaScript to view this survey.</noscript>
  <div id="errbox"></div>

  <div class="custom-header">
    <h3 id="customTitle" class="custom-title"></h3>
    <p id="customDesc" class="custom-description"></p>
  </div>

  <div id="surveyContainer"></div>
</div>

<script>
  /* ===================== CONFIG ===================== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzUQdJ_M27mJF50dYOmOTWePdP2_u5CcIk2KH4pSDi1g4cJ8D1uL5JYVNmEjv2gt8cjCw/exec";
  const SHEETS_WEB_APP_URL = GAS_URL;

  // MSG91 WIDGET creds
  const MSG91_WIDGET_ID = "356c43664a57383136363831";
  const MSG91_TOKEN_AUTH = "484544T7lf8amk695279ebP1";
  const COUNTRY_CODE = "91";

  // Keep verified values OUTSIDE SurveyJS
  let VERIFIED_MOBILE = "";
  let VERIFIED_ACCESS_TOKEN = "";

  /* ===================== ERROR BOX ===================== */
  const showErr = (msg) => {
    const box = document.getElementById("errbox");
    box.style.display = "block";
    box.textContent = msg;
    console.error(msg);
  };
  window.addEventListener("error", e => {
    showErr("Error: " + e.message + "\n" + (e.error && e.error.stack ? e.error.stack : ""));
  });
  window.addEventListener("unhandledrejection", e => {
    showErr("Promise error: " + (e.reason && (e.reason.stack || e.reason.message) || e.reason));
  });

  /* ===================== JSONP helper (GitHub Pages => Apps Script) ===================== */
  function jsonp(url, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const q = new URLSearchParams({ ...params, callback: cb, _ts: String(Date.now()) });
      s.src = url + (url.includes("?") ? "&" : "?") + q.toString();

      let done = false;
      const t = setTimeout(() => {
        if (done) return;
        done = true;
        try { delete window[cb]; } catch {}
        s.remove();
        reject(new Error("JSONP timeout (Apps Script did not respond)."));
      }, 15000);

      window[cb] = (data) => {
        if (done) return;
        done = true;
        clearTimeout(t);
        try { delete window[cb]; } catch {}
        s.remove();
        resolve(data);
      };

      s.onerror = () => {
        if (done) return;
        done = true;
        clearTimeout(t);
        try { delete window[cb]; } catch {}
        s.remove();
        reject(new Error("JSONP load failed. Apps Script did not return callback(...)."));
      };

      document.head.appendChild(s);
    });
  }

  /* ===================== MSG91 OTP widget loader ===================== */
  let _otpSdkReady = false;

  function loadMsg91OtpSdkOnce() {
    if (_otpSdkReady) return Promise.resolve();

    return new Promise((resolve, reject) => {
      const urls = [
        "https://verify.msg91.com/otp-provider.js",
        "https://verify.phone91.com/otp-provider.js"
      ];
      let i = 0;

      const configuration = {
        widgetId: MSG91_WIDGET_ID,
        tokenAuth: MSG91_TOKEN_AUTH,
        exposeMethods: true,
        success: (data) => console.log("MSG91 widget success:", data),
        failure: (error) => console.log("MSG91 widget failure:", error),
      };

      (function attempt() {
        const s = document.createElement("script");
        s.src = urls[i];
        s.async = true;
        s.onload = () => {
          try { if (typeof window.initSendOTP === "function") window.initSendOTP(configuration); } catch {}
          setTimeout(() => {
            if (typeof window.sendOtp === "function" && typeof window.verifyOtp === "function") {
              _otpSdkReady = true;
              resolve();
            } else {
              i++;
              if (i < urls.length) attempt();
              else reject(new Error("MSG91 methods not available. Check widgetId/tokenAuth."));
            }
          }, 400);
        };
        s.onerror = () => {
          i++;
          if (i < urls.length) attempt();
          else reject(new Error("Could not load MSG91 otp-provider.js"));
        };
        document.head.appendChild(s);
      })();
    });
  }

  function extractAccessToken(obj) {
    if (!obj) return "";
    return String(
      obj.message ||
      obj["access-token"] ||
      obj.access_token ||
      obj.accessToken ||
      (obj.data && (obj.data.message || obj.data["access-token"] || obj.data.accessToken)) ||
      ""
    ).trim();
  }

  /* ===================== YOUR FULL SURVEY JSON (unchanged) ===================== */
  const surveyJson = {
    "title": "Survey aimed at understanding the prescribing patterns & perspectives of Indian Gynaecologist for medical treatment to prevent Preterm birth.",
    "description": "Dear Doctor,\r\nProgesterone is commonly produced by the adrenal cortex, ovaries, testes, as well as by the ovarian corpus luteum during the first 10 weeks of pregnancy, followed by the placenta in the later phase of pregnancy. One of the primary responsibilities of progesterone throughout pregnancy is to maintain a decreased level of vascular tone in the myometrium. Low levels of progesterone are known to correlate with miscarriage and pre-term labor. Preterm birth / Preterm labor is the leading cause of perinatal morbidity and mortality worldwide, and its prevention is an important healthcare priority. The finding of a short cervix in the mid-trimester is a powerful risk factor for preterm delivery. The challenge of prediction and prevention of preterm birth has been difficult to address. Recent developments suggest that it is possible to identify a subset of patients at risk for preterm delivery, and to prevent this adverse pregnancy outcome with the use of progestogens. Various Progesterone are used to prevent preterm birth such as oral, vaginal in form of gel, suppositories, capsule, pessaries, Subcutaneous / Intramuscular injections. In this survey, we review an important conceptual framework about preterm birth – specifically, the role of progestogens to prevent preterm birth.\r\n\r\nWe are highly obliged to you for participating in this initiative.\r\nRegards,\r\nCipla\r\n",

    "clearInvisibleValues": "none",

    "pages": [
      {
        "name": "page1",
        "title": "Consent",
        "description": "To, \r\nCipla Ltd \r\nPeninsula Business Park \r\nGanpatrao Kadam Marg \r\nLower Parel, Mumbai – 400013 \r\n\r\nDear Sir/Madam,\r\nI understand that the objective of this survey is to understand the prescribing patterns & perspectives of Indian Gynaecologist for medical treatment to prevent Preterm birth. I hereby agree to share my experience with Cipla Limited (hereinafter “Cipla”) and that Cipla shall have the unfettered right to use it in perpetuity, in all forms of media including but not limited to print, audio, video, website, internet and such other media which is in existence today for display, exhibition, broadcast, transmission, communication or any other media which may come into existence at a future date.\r\nI understand that Cipla shall have all rights to edit, reproduce, adapt, create derivative works or translate any information, views and opinion expressed by me as it deems fit, for the above-mentioned purpose, without my approval. I agree that this is not intended for any promotion or advertisement of any pharmaceutical product.\r\nI hereby confirm that I shall notify Cipla, if I attain a position to influence purchasing decisions of a government entity of health-care-related institution owned or substantially controlled by a government or public body. Such purchasing decisions may relate, for instance, to tenders issued by health authorities or decisions of formulary committees of public hospitals. Where such notification to Cipla is not permitted by local laws, regulations, I shall notify the purchase decision-maker in said government entity, institution or hospital of my relationship with Cipla before any purchasing decision is made.\r\nI am aware of and shall always abide by all the applicable laws governing medical professionals. I expressly release Cipla Limited, it’s employees, representatives, agents etc. from and against any and all claims arising out of the uses herein granted, including without limitation any claims for libel or violation of any right of publicity or privacy.\r\n\r\n\r\nDATA COLLECTION\r\nFill the e-questionnaire form provided to you. The e-questionnaire filled by you will be sent to a statistical agency for data entry and statistical analysis. The doctors will gain access to the e-survey on a dedicated link. The doctor will be prompted digitally to provide his consent and to complete the survey. The confidentiality of data would be maintained as the responses would be totally anonymous as they would be entered with each answer in the server. Proceeding to the next question (including concluding the survey) would be contingent upon answering its previous one, thus ensuring that all respondents answer all questions. The data captured on the Cipla server would only be shared with a statistical agency for analysis. Following doctor data will be collected as a part of the survey – \r\n1.\tDoctor name, age\r\n2.\tName of hospital \r\n3.\tState, city/town\r\n4.\tQualification\r\n5.\tPractice setting \r\n6.\tYears of practice\n",
        "elements": [
          { "type": "html", "name": "otp_block", "html": "<div id='otpMount'></div>" },
          { "type": "boolean", "name": "otpVerified", "defaultValue": false, "visible": false },
          { "type": "text", "name": "mobile_number", "visible": false },

          {
            "type": "checkbox",
            "name": "question2",
            "title": "DATA SHARING CONSENT DECLARATION BY HEALTH CARE PROFESSIONAL\nKindly sign below after agreeing on each of the statement.",
            "isRequired": true,
            "enableIf": "{otpVerified} = true",
            "choices": [
              { "value": "Item 1", "text": "I confirm that I have read and understood the survey protocol." },
              { "value": "Item 2", "text": "I agree not to restrict the use of any data or results that arise from this survey provided such a use is only for scientific purpose(s)." },
              { "value": "Item 3", "text": "I agree to share medical data for the above survey." }
            ],
            "maxSelectedChoices": 3,
            "minSelectedChoices": 3
          },
          { "type": "text", "name": "question1", "title": "Name of the healthcare professional", "isRequired": true, "enableIf": "{otpVerified} = true" },
          { "type": "signaturepad", "name": "question3", "title": "Signature", "isRequired": true, "enableIf": "{otpVerified} = true" },
          { "type": "text", "name": "question4", "title": "Date", "isRequired": true, "inputType": "date", "enableIf": "{otpVerified} = true" }
        ]
      },

      {
        "name": "page2",
        "elements": [
          {
            "type": "radiogroup",
            "name": "question5",
            "title": "1. Out of total deliveries at your hospital, approximately what percentage of deliveries are pre-term?",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "0-5%" },
              { "value": "Item 2", "text": "6-10%" },
              { "value": "Item 3", "text": "11-15%" },
              { "value": "Item 4", "text": "16-20%" },
              { "value": "Item 5", "text": ">20%" }
            ]
          },
          {
            "type": "radiogroup",
            "name": "question6",
            "title": "2. In your practice, approximately what percentage of pregnancies need treatment for PREVENTION of pre-term delivery?",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "<10%" },
              { "value": "Item 2", "text": "10-20%" },
              { "value": "Item 3", "text": "21-30%" },
              { "value": "Item 4", "text": "31-40%" },
              { "value": "Item 5", "text": ">40%" }
            ]
          },
          {
            "type": "checkbox",
            "name": "question7",
            "title": "3. Common risk factors related to pre-term delivery (select 3 options)",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "History of previous pre-term" },
              { "value": "Item 2", "text": "Multiple gestation" },
              { "value": "Item 3", "text": "Short cervix (< 2.5 cm)" },
              { "value": "Item 4", "text": "Preeclampsia" },
              { "value": "Item 5", "text": "Infections" },
              { "value": "Item 6", "text": "Gestational diabetes" },
              { "value": "Item 7", "text": "Spontaneous Pre-term (Idiopathic)" }
            ],
            "maxSelectedChoices": 3,
            "minSelectedChoices": 3
          },
          {
            "type": "checkbox",
            "name": "question8",
            "title": "4. Preferred route of progesterone support? (select maximum two options)",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "Vaginal" },
              { "value": "Item 2", "text": "Oral" },
              { "value": "Item 3", "text": "Injectable" },
              { "value": "Item 4", "text": "Rectal" },
              { "value": "Item 5", "text": "Vaginal + Injectable" },
              { "value": "Item 6", "text": "Oral + Injectable" }
            ],
            "showOtherItem": true,
            "maxSelectedChoices": 2,
            "minSelectedChoices": 1
          },
          {
            "type": "matrixdropdown",
            "name": "q5_progesterone",
            "title": "5. Do you prescribe progesterone for the following risk-factors for Pre-term birth? When yes, please select the molecule and dosage.",
            "columns": [
              {
                "name": "useProg",
                "title": "Use of Progesterone",
                "cellType": "radiogroup",
                "isRequired": true,
                "choices": [ { "value": 1, "text": "Yes" }, { "value": 2, "text": "No" } ],
                "allowClear": true
              },
              {
                "name": "molecule",
                "title": "Molecule",
                "cellType": "dropdown",
                "isRequired": true,
                "visibleIf": "{row.useProg} = 1",
                "choices": [
                  "Vaginal Natural micronized progesterone",
                  "Vaginal gel",
                  "Oral Progesterone",
                  "Dydrogesterone",
                  "Injectable progesterone",
                  "Injectable Hydroxy progesterone"
                ],
                "showOtherItem": true,
                "otherText": "Other (please specify)",
                "otherPlaceholder": "Please specify molecule and its dose",
                "storeOthersAsComment": true,
                "allowClear": true,
                "placeholder": "Select..."
              },
              {
                "name": "dose",
                "title": "Dose",
                "cellType": "dropdown",
                "isRequired": true,
                "visibleIf": "{row.useProg} = 1",
                "enableIf": "{row.useProg} = 1 and {row.molecule} <> 'Other'",
                "resetValueIf": "{row.molecule} = 'Other'",
                "choices": [
                  { "value": "10 mg BID", "visibleIf": "{row.molecule} = 'Dydrogesterone'" },
                  { "value": "10 mg TID", "visibleIf": "{row.molecule} = 'Dydrogesterone'" },
                  { "value": "20 mg OD", "visibleIf": "{row.molecule} = 'Dydrogesterone'" },
                  { "value": "20 mg BID", "visibleIf": "{row.molecule} = 'Dydrogesterone'" },
                  { "value": "20 mg TID", "visibleIf": "{row.molecule} = 'Dydrogesterone'" },

                  { "value": "200 mg BID", "visibleIf": "{row.molecule} = 'Oral Progesterone' or {row.molecule} = 'Vaginal Natural micronized progesterone'" },
                  { "value": "200 mg TID", "visibleIf": "{row.molecule} = 'Oral Progesterone' or {row.molecule} = 'Vaginal Natural micronized progesterone'" },
                  { "value": "300 mg BID", "visibleIf": "{row.molecule} = 'Oral Progesterone' or {row.molecule} = 'Vaginal Natural micronized progesterone'" },
                  { "value": "300 mg TID", "visibleIf": "{row.molecule} = 'Oral Progesterone' or {row.molecule} = 'Vaginal Natural micronized progesterone'" },
                  { "value": "400 mg BID", "visibleIf": "{row.molecule} = 'Oral Progesterone' or {row.molecule} = 'Vaginal Natural micronized progesterone'" },
                  { "value": "400 mg TID", "visibleIf": "{row.molecule} = 'Oral Progesterone' or {row.molecule} = 'Vaginal Natural micronized progesterone'" },

                  { "value": "25 mg", "visibleIf": "{row.molecule} = 'Injectable progesterone'" },
                  { "value": "50 mg", "visibleIf": "{row.molecule} = 'Injectable progesterone'" },
                  { "value": "100 mg", "visibleIf": "{row.molecule} = 'Injectable progesterone'" },

                  { "value": "250 mg", "visibleIf": "{row.molecule} = 'Injectable Hydroxy progesterone'" },
                  { "value": "500 mg", "visibleIf": "{row.molecule} = 'Injectable Hydroxy progesterone'" },

                  { "value": "NA", "visibleIf": "{row.molecule} = 'Vaginal gel'" }
                ],
                "placeholder": "Select..."
              }
            ],
            "rows": [
              { "value": "r1",  "text": "Previous H/o of Preterm labor" },
              { "value": "r2",  "text": "Multiple Gestation" },
              { "value": "r3",  "text": "Short cervix" },
              { "value": "r4",  "text": "Bleeding during 2nd or 3rd Trimester" },
              { "value": "r5",  "text": "Intrauterine Growth Restriction" },
              { "value": "r6",  "text": "Oligohydramnios" },
              { "value": "r7",  "text": "Pregnancy induced hypertension/ Pre-eclampsia" },
              { "value": "r8",  "text": "Uterine infections" },
              { "value": "r9",  "text": "Preterm Prelabor Rupture of Membranes" },
              { "value": "r10", "text": "Gestational diabetes" },
              { "value": "r11", "text": "Anatomical variation / deformities" }
            ]
          },
          {
            "type": "checkbox",
            "name": "question9",
            "title": "6. What common side effects are seen with INJECTABLE (IM/SC) progesterone supplementation? (select maximum 3 options)",
            "isRequired": true,
            "choices": [
              { "value": "Item 4", "text": "Pain" },
              { "value": "Item 5", "text": "Swelling / Inflammation" },
              { "value": "Item 6", "text": "Itching" },
              { "value": "Item 7", "text": "Skin rashes" },
              { "value": "Item 8", "text": "Nausea / Vomiting" },
              { "value": "Item 9", "text": "Breast pain / tenderness" },
              { "value": "Item 10", "text": "Drowsiness or giddiness" },
              { "value": "Item 11", "text": "Migraine / headache" }
            ],
            "maxSelectedChoices": 3,
            "minSelectedChoices": 1
          },
          {
            "type": "checkbox",
            "name": "question10",
            "title": "7. What common side effects are seen with VAGINAL Natural micronized progesterone capsule? (select maximum 3 options)",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "Soreness" },
              { "value": "Item 2", "text": "Diarrhoea" },
              { "value": "Item 3", "text": "Flatulence" },
              { "value": "Item 4", "text": "Vaginal irritation" },
              { "value": "Item 5", "text": "Dryness" },
              { "value": "Item 6", "text": "Spotting" },
              { "value": "Item 7", "text": "Skin rashes" }
            ],
            "maxSelectedChoices": 3,
            "minSelectedChoices": 1
          },
          {
            "type": "checkbox",
            "name": "question11",
            "title": "8. What common side effects are seen with ORAL Natural micronized progesterone tablet? (select maximum 3 options)",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "Nausea / Vomiting" },
              { "value": "Item 2", "text": "Drowsiness or giddiness" },
              { "value": "Item 3", "text": "Migraine / headache" },
              { "value": "Item 4", "text": "Abdominal pain / bloating" },
              { "value": "Item 5", "text": "Breast pain / tenderness" },
              { "value": "Item 6", "text": "Vaginal bleeding" }
            ],
            "maxSelectedChoices": 3,
            "minSelectedChoices": 1
          },
          {
            "type": "checkbox",
            "name": "question13",
            "title": "9. What are the considerations before prescribing progesterone for PREVENTION of Preterm birth? (select maximum 3 options)",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "Cost" },
              { "value": "Item 2", "text": "Efficacy" },
              { "value": "Item 3", "text": "Safety" },
              { "value": "Item 4", "text": "Route of administration" },
              { "value": "Item 5", "text": "Patient compliance" }
            ],
            "maxSelectedChoices": 3,
            "minSelectedChoices": 1
          }
        ]
      },

      {
        "name": "page3",
        "elements": [
          { "type": "text", "name": "question12", "title": "Email-id", "isRequired": true },
          { "type": "text", "name": "question15", "title": "Age", "isRequired": true },
          {
            "type": "radiogroup",
            "name": "question16",
            "title": "Years of clinical experience",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "<5 years" },
              { "value": "Item 2", "text": "5-10 years" },
              { "value": "Item 3", "text": "11-20 years" },
              { "value": "Item 4", "text": ">20 years" }
            ]
          },
          {
            "type": "checkbox",
            "name": "question17",
            "title": "Pre-dominant type of practice",
            "isRequired": true,
            "choices": [
              { "value": "Item 1", "text": "Multi-specialty Hospital" },
              { "value": "Item 2", "text": "Clinic / Nursing Home" },
              { "value": "Item 3", "text": "Government Hospital / Medical College" },
              { "value": "Item 4", "text": "Mixed Practice" }
            ],
            "minSelectedChoices": 1,
            "maxSelectedChoices": 1
          },
          { "type": "text", "name": "question14", "title": "Address (City and State)", "isRequired": true }
        ]
      }
    ],
    "headerView": "advanced"
  };

  const survey = new Survey.Model(surveyJson);

  // Move title/description into custom header
  document.getElementById("customTitle").textContent = survey.title || "";
  document.getElementById("customDesc").textContent  = survey.description || "";
  survey.title = "";
  survey.description = "";

  /* ===================== OTP UI ===================== */
  let otpReqId = "";

  function renderOtpUI(mountEl) {
    if (!mountEl) return;

    if (survey.getValue("otpVerified") === true) {
      mountEl.innerHTML = `
        <div class="otpBox">
          <div class="otpOk">✅ Mobile verified.</div>
          <div class="otpHint">Consent and signature fields are enabled.</div>
        </div>`;
      return;
    }

    mountEl.innerHTML = `
      <div class="otpBox">
        <div class="otpTitle">Mobile Verification (MSG91 OTP Widget)</div>
        <div class="otpHint">Complete OTP verification here. After verification, consent/signature will be enabled.</div>

        <div class="otpRow">
          <input id="otp_mobile" type="tel" placeholder="10-digit mobile number" inputmode="numeric" />
          <button id="otp_send" type="button">Send OTP</button>
        </div>

        <div id="otp_row2" class="otpRow" style="display:none;">
          <input id="otp_code" type="text" placeholder="Enter OTP" inputmode="numeric" />
          <button id="otp_verify" type="button">Verify OTP</button>
        </div>

        <div id="otp_msg" class="otpHint"></div>
      </div>
    `;

    const $ = (id) => mountEl.querySelector("#" + id);
    const setMsg = (html) => { const m = $("otp_msg"); if (m) m.innerHTML = html; };

    $("otp_send").addEventListener("click", async () => {
      const mobile = ($("otp_mobile").value || "").trim();
      if (!/^[6-9]\d{9}$/.test(mobile)) { alert("Enter valid mobile number"); return; }

      try { await loadMsg91OtpSdkOnce(); }
      catch (e) { setMsg(`<span class="otpBad">MSG91 methods not available. Check widget/token.</span>`); return; }

      const identifier = COUNTRY_CODE + mobile;

      window.sendOtp(
        identifier,
        (data) => {
          otpReqId = data?.reqId || data?.request_id || data?.requestId || "";
          $("otp_row2").style.display = "flex";

          VERIFIED_MOBILE = mobile;
          survey.setValue("mobile_number", mobile);

          setMsg(`✅ OTP sent to <b>${mobile}</b>.`);
        },
        () => {
          setMsg(`<span class="otpBad">OTP send failed.</span>`);
          alert("OTP send failed. Please try again.");
        }
      );
    });

    $("otp_verify").addEventListener("click", async () => {
      const mobile = ($("otp_mobile").value || "").trim();
      const otp = ($("otp_code").value || "").trim();
      if (!/^[6-9]\d{9}$/.test(mobile)) { alert("Enter valid mobile number"); return; }
      if (!/^\d{4,8}$/.test(otp)) { alert("Enter valid OTP"); return; }

      try { await loadMsg91OtpSdkOnce(); }
      catch (e) { setMsg(`<span class="otpBad">MSG91 methods not available. Check widget/token.</span>`); return; }

      window.verifyOtp(
        otp,
        async (data) => {
          const token = extractAccessToken(data);
          if (!token) { setMsg(`<span class="otpBad">OTP verified, but access token not found.</span>`); return; }
          VERIFIED_ACCESS_TOKEN = token;

          try {
            const v = await jsonp(GAS_URL, { action:"verifyAccessToken", mobile, access_token: token });
            if (v && v.ok) {
              VERIFIED_MOBILE = mobile;
              survey.setValue("mobile_number", mobile);
              survey.setValue("otpVerified", true);
              alert("Mobile verified. You can now sign the consent.");
              survey.render();
            } else {
              setMsg(`<span class="otpBad">Server verification failed.</span>`);
              alert("Server verification failed. Please retry OTP.");
            }
          } catch (e) {
            setMsg(`<span class="otpBad">Server verification failed (JSONP).</span>`);
            alert("Server verification failed (JSONP). Please retry.");
          }
        },
        () => {
          setMsg(`<span class="otpBad">OTP verify failed.</span>`);
          alert("OTP verify failed. Please try again.");
        },
        otpReqId || undefined
      );
    });
  }

  survey.onAfterRenderQuestion.add((s, opt) => {
    if (opt.question && opt.question.name === "otp_block") {
      const mount = opt.htmlElement.querySelector("#otpMount");
      renderOtpUI(mount);
    }
  });

  survey.onCurrentPageChanging.add((s, opt) => {
    const oldp = opt.oldCurrentPage;
    const newp = opt.newCurrentPage;
    if (!oldp || !newp) return;
    if (oldp.name === "page1" && newp.name !== "page1" && !s.getValue("otpVerified")) {
      opt.allowChanging = false;
      alert("Please verify your mobile number first.");
    }
  });

  survey.onCompleting.add((s, opt) => {
    if (!s.getValue("otpVerified")) {
      opt.allowComplete = false;
      alert("Please verify your mobile number first.");
    }
  });

  // ✅ FIXED: SurveyJS onComplete signature
  survey.onComplete.add(async (sender) => {
    try {
      const data = sender.data || {};
      const mobile = String(VERIFIED_MOBILE || sender.getValue("mobile_number") || "").trim();
      const meta = Object.fromEntries(new URLSearchParams(location.search).entries());

      const payload = {
        ...data,
        _meta: {
          ...meta,
          submittedAt: new Date().toISOString(),
          mobile,
          access_token: VERIFIED_ACCESS_TOKEN
        }
      };

      console.log("Submitting to GAS:", SHEETS_WEB_APP_URL, payload);

      await fetch(SHEETS_WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      alert("Thanks! Your response has been recorded.");
    } catch (err) {
      console.error(err);
      showErr("Submit error: " + (err && (err.stack || err.message) || err));
      alert("Submitted, but we couldn't confirm the save.");
    }
  });

  survey.render(document.getElementById("surveyContainer"));
</script>
</body>
</html>





